import streamlit as st
import pandas as pd
import numpy as np
import importlib.util
import os

# --- 1. SETUP & MODULE LOADING ---
st.set_page_config(page_title="VC Instructor Desk", layout="wide")

def load_mod(name):
    path = os.path.join(os.path.dirname(__file__), name)
    spec = importlib.util.spec_from_file_location(name, path)
    mod = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(mod)
    return mod

# Load shared narrative and the new instructor engine
try:
    nav = load_mod("02_vc_lab_narrative.py")
    inst_eng = load_mod("02_vc_instructor_engine.py")
except Exception as e:
    st.error(f"Error loading modules: {e}")
    st.stop()

st.title("üèÜ VC Competition: Strategy Leaderboard")

# --- 2. SECURITY BARRIER ---
pwd = st.sidebar.text_input("Instructor Password", type="password")

# Replace 'VC_LEADER' with your preferred password
if pwd == "VC_ADMIN_2026":
    
    # --- 3. SECRET SCENARIO SETUP ---
    with st.expander("üõ†Ô∏è Secret Scenario Configuration", expanded=True):
        col1, col2 = st.columns(2)
        m_sel = col1.selectbox("Set Secret Market", list(nav.MARKET_STORIES.keys()))
        
        # Seed ensures p-values match the students' lab experience
        day_seed_input = col2.text_input("Day Seed (Enter Student Lab ID)", value="LAB123")
        day_seed = sum(ord(c) for c in day_seed_input)
        np.random.seed(day_seed)
        
        # Re-generate the p_matrix internally to maintain parity with the lab
        m_base = {"Market A: The Boom": 0.9, "Market B: The Squeeze": 0.7, "Market C: Rule Change": 0.8}
        s_mult = {"Type 1: The Basics": 1.0, "Type 2: Tech Apps": 0.6, "Type 3: Big Science": 0.2}
        p_matrix = {m: {s: np.clip(p*s_mult[s] + np.random.normal(0,0.02), 0.01, 0.99) 
                       for s in nav.TYPE_STORY} for m, p in m_base.items()}

    # --- 4. THE CIRCUMSPECT BRIEFING (Show to Class) ---
    st.header("üì¢ Current Market Briefing")
    st.info(f"**Field Report:** {nav.MARKET_STORIES[m_sel]}")
    st.caption("Instructions: Choose your Investment Sector and Reinvestment Fraction (f) based on this description.")

    # --- 5. STUDENT SUBMISSIONS ---
    st.divider()
    st.subheader("Contestant Registration")
    
    if "contestants" not in st.session_state:
        st.session_state.contestants = []

    with st.form("entry_form", clear_on_submit=True):
        f_col1, f_col2, f_col3 = st.columns([2, 2, 1])
        s_name = f_col1.text_input("Student Name")
        s_sec = f_col2.selectbox("Chosen Sector", list(nav.TYPE_STORY.keys()))
        s_f = f_col3.number_input("Strategy (f)", 0.0, 1.0, 0.1, step=0.01)
        
        if st.form_submit_button("Add Strategy"):
            if s_name:
                st.session_state.contestants.append({"Name": s_name, "Sector": s_sec, "f": s_f})
                st.rerun()

    # Display Current Roster
    if st.session_state.contestants:
        st.write(f"**Current Roster:** {', '.join([c['Name'] for c in st.session_state.contestants])}")

    # --- 6. THE COMPETITION RUN ---
    if st.session_state.contestants and st.button("üöÄ RUN 10,000-TRIAL SIMULATION"):
        results = []
        for c in st.session_state.contestants:
            # Retrieve ground truth for the student's specific combination
            p_true = p_matrix[m_sel][c['Sector']]
            b_val = nav.B_VALS[c['Sector']]
            
            # Execute simulation
            stats = inst_eng.run_competition_sim(c['f'], p_true, b_val)
            
            # Append metadata for the table
            stats["Student"] = c['Name']
            stats["Sector Choice"] = c['Sector']
            stats["Strategy (f)"] = c['f']
            results.append(stats)
            
        # --- 7. THE LEADERBOARD & FULL STORY ---
        df = pd.DataFrame(results)
        
        # Order columns to emphasize the 'Full Story' of risk
        display_cols = [
            "Student", "Sector Choice", "Strategy (f)", "Median", 
            "Insolvency Rate", "Min", "Q1", "Q3", "Max", "Mean", "Std Dev"
        ]
        
        df = df[display_cols].sort_values("Median", ascending=False)
        
        st.header("üìä Final Competition Results")
        st.balloons()
        
        # Formatting the table for readability
        st.dataframe(df.style.format({
            "Median": "${:,.2f}", "Mean": "${:,.2f}", "Max": "${:,.2f}", 
            "Min": "${:,.2f}", "Q1": "${:,.2f}", "Q3": "${:,.2f}",
            "Insolvency Rate": "{:.1%}", "Std Dev": "{:,.2f}"
        }), use_container_width=True)
        
        st.success("Note: Rankings are determined by Median Wealth. Compare the Mean vs. Median to find the 'Gamblers'.")

    if st.button("Clear All Contestants"):
        st.session_state.contestants = []
        st.rerun()

else:
    # Basic protection if password is wrong
    if pwd != "":
        st.error("Incorrect Password.")
    st.warning("Please enter the Instructor Password in the sidebar to access the competition controls.")

# --- SAFETY PADDING ---
# 1
# 2
# 3
# 4
# 5
# 6
# 7
# 8
# 9
# 10
# --- END OF FILE ---
